// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üß† PersonalizationEngine.js - Version Propre & Compatible
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

import ContentManager from './ContentManager.js';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìä DONN√âES STATIQUES OPTIMIS√âES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const PERSONA_PROMPTS = {
  menstrual: {
    emma: [
      "Comment honorer ton besoin de repos aujourd'hui ? üåô",
      "Que ressent ton corps pendant tes r√®gles ?",
      "Comment transformer cette p√©riode en moment cocooning ?"
    ],
    laure: [
      "Comment adapter ton planning pendant tes r√®gles ?",
      "Quelle organisation optimise ton √©nergie actuelle ?",
      "Comment maintenir ta productivit√© en respectant ton corps ?"
    ],
    clara: [
      "Comment transformer l'√©nergie de tes r√®gles en force ?",
      "Quel superpouvoir d√©couvres-tu pendant cette phase ?",
      "Comment utiliser cette introspection pour grandir ?"
    ],
    sylvie: [
      "Comment m'offrir la douceur dont j'ai besoin ?",
      "Qu'est-ce que mon corps me demande vraiment ?",
      "Comment honorer cette sagesse que mon corps partage ?"
    ],
    christine: [
      "Comment transformer ce moment en rituel de ressourcement ?",
      "Quelle sagesse mon corps me transmet-il dans cette phase ?",
      "Comment honorer cette p√©riode sacr√©e ?"
    ]
  },
  follicular: {
    emma: [
      "Comment canaliser cette √©nergie qui remonte ? ‚ú®",
      "Quels nouveaux projets t'inspirent ?",
      "Comment explorer cette renaissance √©nerg√©tique ?"
    ],
    laure: [
      "Comment structurer tes objectifs pour cette phase √©nerg√©tique ?",
      "Quelles initiatives vais-je lancer avec cette √©nergie montante ?",
      "Comment planifier pour maximiser cette phase ?"
    ],
    clara: [
      "Comment exploiter au max cette phase de cr√©ation ?",
      "Comment transformer cette √©nergie en r√©sultats concrets ?",
      "Quel potentiel d√©bloquer avec cette √©nergie ?"
    ],
    sylvie: [
      "Comment cultiver mes aspirations avec douceur ?",
      "Quelles graines vais-je planter pour mon √©panouissement ?",
      "Comment nourrir mes r√™ves naissants ?"
    ],
    christine: [
      "Comment harmoniser cette renaissance avec ma sagesse ?",
      "Quelle vision sage √©merge de cette √©nergie cr√©atrice ?",
      "Comment √©veiller mon potentiel avec gr√¢ce ?"
    ]
  },
  ovulatory: {
    emma: [
      "Comment utiliser cette √©nergie communicative ? üåü",
      "Qu'est-ce que j'ai envie d'exprimer au monde ?",
      "Comment rayonner pleinement aujourd'hui ?"
    ],
    laure: [
      "Comment optimiser mes interactions et pr√©sentations ?",
      "Comment maximiser mon impact relationnel aujourd'hui ?",
      "Comment communiquer efficacement avec cette √©nergie ?"
    ],
    clara: [
      "Comment exploiter cette confiance ultime ?",
      "Comment transformer cette √©nergie en leadership ?",
      "Comment dominer mes interactions aujourd'hui ?"
    ],
    sylvie: [
      "Comment rayonner ma bienveillance naturelle ?",
      "Comment utiliser cette √©nergie pour nourrir mes relations ?",
      "Comment partager ma lumi√®re avec le monde ?"
    ],
    christine: [
      "Comment partager mes apprentissages avec gr√¢ce ?",
      "Quelle sagesse puis-je offrir avec cette √©nergie rayonnante ?",
      "Comment transmettre ma sagesse aujourd'hui ?"
    ]
  },
  luteal: {
    emma: [
      "Comment mieux respecter mes limites ? üçÇ",
      "Qu'est-ce que j'ai appris sur moi ce cycle ?",
      "Comment √©couter mon intuition profonde ?"
    ],
    laure: [
      "Comment structurer mes priorit√©s avec cette √©nergie focus ?",
      "Quelles am√©liorations vais-je impl√©menter ?",
      "Comment organiser et finaliser mes projets ?"
    ],
    clara: [
      "Comment transformer cette intensit√© en superpouvoir ?",
      "Quels insights r√©v√®lent mes patterns lut√©aux ?",
      "Comment ma√Ætriser les d√©fis de cette phase ?"
    ],
    sylvie: [
      "Comment accueillir cette sensibilit√© avec tendresse ?",
      "Quelle sagesse ce cycle m'a-t-il apport√©e ?",
      "Comment c√¢liner mes √©motions intenses ?"
    ],
    christine: [
      "Comment honorer cette phase de transformation int√©rieure ?",
      "Quelles v√©rit√©s profondes √©mergent de cette introspection ?",
      "Comment savourer cette profondeur cyclique ?"
    ]
  }
};

const PREFERENCE_PROMPTS = {
  symptoms: [
    "Comment soulager naturellement tes sympt√¥mes ?",
    "Quels signaux ton corps t'envoie-t-il ?",
    "Comment interpr√©ter ces sensations physiques ?"
  ],
  moods: [
    "Comment accueillir tes √©motions cycliques ?",
    "Que r√©v√®lent tes changements d'humeur ?",
    "Comment transformer l'intensit√© √©motionnelle ?"
  ],
  phyto: [
    "Quelles plantes peuvent t'accompagner ?",
    "Comment la nature peut-elle soutenir ton cycle ?",
    "Quels rem√®des naturels explorer ?"
  ],
  phases: [
    "Comment optimiser cette phase cyclique ?",
    "Quelle √©nergie cette phase t'offre-t-elle ?",
    "Comment honorer cette p√©riode unique ?"
  ],
  rituals: [
    "Quels rituels honorer aujourd'hui ?",
    "Comment cr√©er un moment sacr√© pour toi ?",
    "Comment transformer cette journ√©e en rituel ?"
  ]
};

const ACTION_CONFIG = {
  chat: {
    icons: { menstrual: 'üí≠', follicular: 'üå±', ovulatory: 'üí¨', luteal: 'üîÆ' },
    titles: {
      emma: 'Explore tes ressentis',
      laure: 'Optimise ta communication', 
      clara: 'Exprime ta puissance',
      sylvie: 'Partage tes √©motions',
      christine: 'Transmets ta sagesse'
    }
  },
  notebook: {
    icons: { menstrual: '‚úçÔ∏è', follicular: 'üí°', ovulatory: 'üé®', luteal: 'üìö' },
    titles: {
      emma: 'Note tes d√©couvertes',
      laure: 'Structure tes observations',
      clara: 'Capture tes insights', 
      sylvie: 'Recueille tes ressentis',
      christine: 'Consigne ta sagesse'
    }
  },
  phase_detail: {
    icons: { menstrual: 'üåô', follicular: 'üå∏', ovulatory: '‚òÄÔ∏è', luteal: 'üçÇ' },
    titles: {
      emma: 'D√©couvre cette phase',
      laure: 'Ma√Ætrise cette phase',
      clara: 'Conquiers cette phase',
      sylvie: 'Comprends cette phase', 
      christine: 'Explore le myst√®re'
    }
  }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üè≠ FACTORY FUNCTION PRINCIPALE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export const createPersonalizationEngine = (intelligenceData, preferences, currentPhase, persona) => {
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // üß† G√âN√âRATION PROMPTS PERSONNALIS√âS
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  const generatePersonalizedPrompts = () => {
    const prompts = [];
    
    // 1. Prompts persona + phase (priorit√© haute)
    const phasePrompts = PERSONA_PROMPTS[currentPhase]?.[persona] || [];
    prompts.push(...phasePrompts.slice(0, 2));
    
    // 2. Prompts pr√©f√©rence dominante
    const dominantPref = getDominantPreference(preferences);
    if (dominantPref && PREFERENCE_PROMPTS[dominantPref]) {
      prompts.push(PREFERENCE_PROMPTS[dominantPref][0]);
    }
    
    // 3. Prompts apprentissage (si confidence > 30)
    if (intelligenceData.learning.confidence > 30) {
      const learnedPrompts = getLearnedPrompts();
      prompts.push(...learnedPrompts.slice(0, 1));
    }
    
    // 4. Fallback si pas assez de prompts
    if (prompts.length < 3) {
      prompts.push("Comment te sens-tu en ce moment ?");
    }
    
    return prompts.slice(0, 3);
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // üéØ G√âN√âRATION ACTIONS CONTEXTUELLES  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  const generateContextualActions = () => {
    const actions = [];
    
    // Action 1: Chat toujours disponible
    const chatPrompts = generatePersonalizedPrompts();
    actions.push({
      type: 'chat',
      priority: 'high',
      title: ACTION_CONFIG.chat.titles[persona],
      label: ACTION_CONFIG.chat.titles[persona], // Pour useSmartSuggestions
      prompt: chatPrompts[0],
      icon: ACTION_CONFIG.chat.icons[currentPhase],
      confidence: Math.min(intelligenceData.learning.confidence + 30, 100)
    });
    
    // Action 2: Notebook si pr√©f√©rence √©motions/tracking
    if (shouldShowNotebook()) {
      actions.push({
        type: 'notebook',
        priority: 'medium',
        title: ACTION_CONFIG.notebook.titles[persona],
        label: ACTION_CONFIG.notebook.titles[persona],
        prompt: getNotebookPrompt(),
        icon: ACTION_CONFIG.notebook.icons[currentPhase],
        confidence: intelligenceData.learning.confidence
      });
    }
    
    // Action 3: Phase detail si confidence faible ou nouvelle phase
    if (shouldShowPhaseDetail()) {
      actions.push({
        type: 'phase_detail', 
        priority: 'low',
        title: ACTION_CONFIG.phase_detail.titles[persona],
        label: ACTION_CONFIG.phase_detail.titles[persona],
        prompt: null,
        icon: ACTION_CONFIG.phase_detail.icons[currentPhase],
        confidence: 100 - intelligenceData.learning.confidence
      });
    }
    
    return actions.slice(0, 3);
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // üõ†Ô∏è FONCTIONS UTILITAIRES
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  const getDominantPreference = (prefs) => {
    if (!prefs || typeof prefs !== 'object') return null;
    
    return Object.entries(prefs)
      .filter(([_, value]) => value >= 4)
      .sort(([_, a], [__, b]) => b - a)[0]?.[0] || null;
  };
  
  const getLearnedPrompts = () => {
    // Simul√© - √† connecter avec vraie intelligence
    return ["Comment d√©velopper ce qui a march√© hier ?"];
  };
  
  const shouldShowNotebook = () => {
    return preferences.moods >= 4 || 
           preferences.symptoms >= 4 ||
           currentPhase === 'luteal';
  };
  
  const shouldShowPhaseDetail = () => {
    return intelligenceData.learning.confidence < 50 ||
           !intelligenceData.learning.phasePatterns?.[currentPhase];
  };
  
  const getNotebookPrompt = () => {
    const prompts = {
      menstrual: "Qu'est-ce que mon corps me demande vraiment ?",
      follicular: "Quels projets m'inspirent en ce moment ?", 
      ovulatory: "Comment puis-je rayonner davantage ?",
      luteal: "Que m'enseigne cette sensibilit√© ?"
    };
    
    return prompts[currentPhase] || "Que ressens-tu maintenant ?";
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // üìä M√âTADONN√âES PERSONNALISATION
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  const getPersonalizationMetadata = () => {
    const learning = intelligenceData.learning;
    
    return {
      confidence: learning.confidence,
      dataPoints: {
        timePatterns: learning.timePatterns?.favoriteHours?.length || 0,
        phaseData: Object.keys(learning.phasePatterns || {}).length,
        conversationHistory: learning.conversationCount || 0
      },
      recommendations: getRecommendations(learning.confidence)
    };
  };
  
  const getRecommendations = (confidence) => {
    const recommendations = [];
    
    if (confidence < 30) {
      recommendations.push("Continue tes interactions pour une personnalisation optimale");
    }
    
    if (confidence > 70) {
      recommendations.push("Tes donn√©es permettent des suggestions tr√®s personnalis√©es !");
    }
    
    return recommendations;
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // üéØ API PUBLIQUE
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  const createPersonalizedExperience = () => {
    return {
      personalizedPrompts: generatePersonalizedPrompts(),
      contextualActions: generateContextualActions(),
      personalization: getPersonalizationMetadata()
    };
  };

  return {
    createPersonalizedExperience,
    generatePersonalizedPrompts,
    generateContextualActions,
    getPersonalizationMetadata
  };
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üéØ FONCTION CONTEXTUELLE AUTONOME (pour l'API backend)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export const getContextualMessage = async (phase, persona, journey, preferences) => {
  try {
    const phasesData = await ContentManager.getPhases();
    const phaseData = phasesData[phase];
    
    if (!phaseData?.contextualEnrichments?.length) {
      return phaseData?.description || "Explorons ensemble cette p√©riode de ton cycle.";
    }

    // Scoring enrichissements
    let bestMatch = null;
    let bestScore = -1;

    for (const enrichment of phaseData.contextualEnrichments) {
      let score = 0;
      
      if (enrichment.targetPersona === persona) score += 100;
      if (enrichment.targetJourney === journey) score += 50;
      if (preferences?.includes?.(enrichment.targetPreferences?.[0])) score += 25;
      
      if (score > bestScore) {
        bestScore = score;
        bestMatch = enrichment;
      }
    }

    return bestMatch?.contextualText || phaseData.description;
  } catch (error) {
    console.warn('üö® getContextualMessage error:', error);
    return "Explorons ensemble cette p√©riode de ton cycle.";
  }
};