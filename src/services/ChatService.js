//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“„ File: src/services/ChatService.js
// ðŸ§© Type: Service
// ðŸ“š Description: Service chat avec stores intÃ©grÃ©s + intelligence contextuelle
// ðŸ•’ Version: 5.0 - 2025-06-21 - STORES INTÃ‰GRÃ‰S
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
import AsyncStorage from '@react-native-async-storage/async-storage';
import { useUserStore } from '../stores/useUserStore.js';
import { useChatStore } from '../stores/useChatStore.js';
import { useEngagementStore } from '../stores/useEngagementStore.js';
import { useUserIntelligence } from '../stores/useUserIntelligence.js';
import { getApiRequestConfig } from '../config/api.js';
import { getCurrentPhase } from '../utils/cycleCalculations.js';

const DEVICE_ID_KEY = 'device_id_v1';

// âœ… FALLBACKS INTELLIGENTS PAR PERSONA
const SMART_FALLBACKS = {
  emma: {
    "Comment te sens-tu aujourd'hui?": "Hey ! ðŸ˜Š Raconte-moi ce qui se passe pour toi en ce moment !",
    "Pourquoi je me sens si fatiguÃ©e?": "Oh je comprends... Cette fatigue peut Ãªtre liÃ©e Ã  ton cycle ! Ton corps fait un travail incroyable ðŸ’ª",
    "Quels aliments me recommandes-tu?": "Pour ton Ã©nergie du moment, pense fer et protÃ©ines ! Des Ã©pinards, des lentilles... tes alliÃ©s ! âœ¨"
  },
  laure: {
    "Comment te sens-tu aujourd'hui?": "Analysons ensemble votre Ã©tat du jour. Quels sont vos ressentis principaux ?",
    "Pourquoi je me sens si fatiguÃ©e?": "Cette fatigue est probablement cyclique. Vos hormones influencent directement votre niveau d'Ã©nergie.",
    "Quels aliments me recommandes-tu?": "Optimisez votre alimentation : fer, magnÃ©sium, omÃ©ga-3. Planifiez selon votre phase cyclique."
  },
  clara: {
    "Comment te sens-tu aujourd'hui?": "Wow, quelle belle opportunitÃ© d'explorer tes ressentis ! Raconte-moi tout ! ðŸŒŸ",
    "Pourquoi je me sens si fatiguÃ©e?": "Ta fatigue est un message de ton corps ! Il te guide vers plus de douceur envers toi-mÃªme ðŸ’•",
    "Quels aliments me recommandes-tu?": "Nourris ton temple avec amour ! Pense lÃ©gumes verts, graines... tout ce qui fait vibrer ton Ã©nergie ! âœ¨"
  },
  sylvie: {
    "Comment te sens-tu aujourd'hui?": "Ma chÃ¨re, prenons le temps d'accueillir ce que tu ressens aujourd'hui.",
    "Pourquoi je me sens si fatiguÃ©e?": "Cette fatigue fait partie du rythme naturel de ton corps. Honore ce besoin de ralentir.",
    "Quels aliments me recommandes-tu?": "Pense Ã  des aliments nourrissants : bouillons, lÃ©gumes de saison, tout ce qui rÃ©conforte."
  },
  christine: {
    "Comment te sens-tu aujourd'hui?": "Bonjour. Comment se prÃ©sente cette journÃ©e pour vous ?",
    "Pourquoi je me sens si fatiguÃ©e?": "La fatigue accompagne souvent les changements hormonaux. C'est tout Ã  fait normal.",
    "Quels aliments me recommandes-tu?": "PrivilÃ©giez une alimentation Ã©quilibrÃ©e, riche en nutriments essentiels pour cette pÃ©riode."
  }
};

class ChatService {
  constructor() {
    this.deviceId = null;
    this.isInitialized = false;
    this.conversationContext = {
      messageCount: 0,
      topics: [],
      lastPhase: null,
      userPatterns: {}
    };
  }

  async initialize() {
    if (this.isInitialized) return;
    
    try {
      this.deviceId = await this.getOrGenerateDeviceId();
      this.isInitialized = true;
      
      // âœ… INITIALISER CONTEXTE INTELLIGENCE
      this.loadConversationContext();
      
      console.log('ðŸš€ ChatService initialisÃ© avec Device ID:', this.deviceId);
    } catch (error) {
      console.error('ðŸš¨ Erreur initialisation ChatService:', error);
      this.deviceId = 'fallback-device-id';
      this.isInitialized = true;
    }
  }

  async getOrGenerateDeviceId() {
    try {
      let deviceId = await AsyncStorage.getItem(DEVICE_ID_KEY);
      
      if (!deviceId) {
        deviceId = this.generateDeviceId();
        await AsyncStorage.setItem(DEVICE_ID_KEY, deviceId);
      }
      
      return deviceId;
    } catch (error) {
      console.warn('ðŸš¨ Erreur Device ID, fallback:', error);
      return this.generateDeviceId();
    }
  }

  generateDeviceId() {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substr(2, 9);
    return `moodcycle-${timestamp}-${random}`;
  }

  // âœ… NOUVEAU : Contexte intelligent
  loadConversationContext() {
    try {
      const chatStore = useChatStore.getState();
      const engagementStore = useEngagementStore.getState();
      
      this.conversationContext = {
        messageCount: chatStore.getMessagesCount().total,
        topics: this.extractTopicsFromMessages(chatStore.messages),
        lastPhase: null,
        userPatterns: engagementStore.getPatterns?.() || {}
      };
    } catch (error) {
      console.warn('ðŸš¨ Erreur load context:', error);
    }
  }

  extractTopicsFromMessages(messages) {
    const recentMessages = messages.slice(-10);
    const topics = [];
    
    recentMessages.forEach(msg => {
      if (msg.type === 'user') {
        // Extraction basique de topics
        const content = msg.content.toLowerCase();
        if (content.includes('fatigue') || content.includes('Ã©nergie')) topics.push('energy');
        if (content.includes('humeur') || content.includes('Ã©motions')) topics.push('mood');
        if (content.includes('douleur') || content.includes('mal')) topics.push('pain');
        if (content.includes('alimentation') || content.includes('manger')) topics.push('nutrition');
      }
    });
    
    return [...new Set(topics)];
  }

  async sendMessage(message) {
    if (!this.isInitialized) {
      await this.initialize();
    }

    try {
      // âœ… NOUVEAU : Contexte enrichi depuis stores
      const enrichedContext = await this.buildEnrichedContext(message);
      
      // âœ… TRACKING ENGAGEMENT
      this.trackEngagement(message, enrichedContext);
      
      const response = await this.callChatAPI(message, enrichedContext);
      
      // âœ… APPRENTISSAGE PATTERNS
      this.learnFromResponse(message, response, enrichedContext);
      
      return {
        success: true,
        message: response,
        source: 'api',
        context: enrichedContext.persona
      };
    } catch (error) {
      console.error('ðŸš¨ Erreur sendMessage:', error);
      
      const fallbackResponse = this.getSmartFallbackResponse(message);
      return fallbackResponse;
    }
  }

  // âœ… NOUVEAU : Contexte enrichi
  async buildEnrichedContext(message) {
    const userStore = useUserStore.getState();
    const chatStore = useChatStore.getState();
    const engagementStore = useEngagementStore.getState();
    
    // Contexte de base
    const baseContext = userStore.getContextForAPI();
    
    // Phase actuelle calculÃ©e
    const currentPhase = getCurrentPhase(
      userStore.cycle.lastPeriodDate,
      userStore.cycle.length,
      userStore.cycle.periodDuration
    );
    
    // Intelligence contextuelle
    const intelligence = {
      conversationLength: chatStore.messages.length,
      recentTopics: this.conversationContext.topics,
      userEngagement: engagementStore.getEngagementLevel?.() || 'medium',
      patterns: engagementStore.getPatterns?.() || {},
      timeOfDay: new Date().getHours(),
      daysSinceFirstUse: engagementStore.metrics?.daysUsed || 1
    };
    
    // Suggestions contextuelles
    const suggestions = chatStore.getContextualSuggestions();
    
    return {
      ...baseContext,
      phase: currentPhase,
      intelligence,
      suggestions,
      conversationContext: this.conversationContext,
      messageMetadata: {
        isFirstMessage: chatStore.messages.length === 0,
        isReturningUser: intelligence.daysSinceFirstUse > 1,
        hasUsedVignettes: engagementStore.metrics?.vignetteEngagements > 0
      }
    };
  }

  // âœ… NOUVEAU : Tracking engagement
  trackEngagement(message, context) {
    try {
      const engagementStore = useEngagementStore.getState();
      
      engagementStore.trackAction?.('message_sent', {
        messageLength: message.length,
        phase: context.phase,
        persona: context.persona,
        topics: this.extractTopicsFromMessages([{ content: message, type: 'user' }]),
        timeOfDay: new Date().getHours(),
        conversationLength: context.intelligence.conversationLength
      });
      
      // Update conversation context
      this.conversationContext.messageCount++;
      this.conversationContext.lastPhase = context.phase;
    } catch (error) {
      console.warn('ðŸš¨ Erreur tracking engagement:', error);
    }
  }

  // âœ… NOUVEAU : Apprentissage patterns
  learnFromResponse(message, response, context) {
    try {
      const userIntelligence = useUserIntelligence.getState();
      
      userIntelligence.recordInteraction?.({
        input: message,
        response: response,
        phase: context.phase,
        persona: context.persona,
        timestamp: Date.now(),
        context: {
          topics: this.extractTopicsFromMessages([{ content: message, type: 'user' }]),
          engagement: context.intelligence.userEngagement
        }
      });
    } catch (error) {
      console.warn('ðŸš¨ Erreur learning patterns:', error);
    }
  }

  async callChatAPI(message, context) {
    const apiConfig = getApiRequestConfig(this.deviceId);

    const response = await fetch(`${apiConfig.baseURL}/api/chat`, {
      method: 'POST',
      headers: apiConfig.headers,
      body: JSON.stringify({
        message,
        context,
      }),
      timeout: apiConfig.timeout,
    });

    if (!response.ok) {
      throw new Error(`API Error: ${response.status}`);
    }

    const data = await response.json();

    if (data.response) return data.response;
    if (data.message) return data.message;
    if (data.data?.message) return data.data.message;
    
    throw new Error('Format de rÃ©ponse API non reconnu');
  }

  // âœ… NOUVEAU : Fallbacks intelligents
  getSmartFallbackResponse(message) {
    const userStore = useUserStore.getState();
    const persona = userStore.persona.assigned || 'emma';
    
    // Fallback spÃ©cifique au persona
    const personaFallbacks = SMART_FALLBACKS[persona] || SMART_FALLBACKS.emma;
    
    // Recherche exacte
    let fallbackMessage = personaFallbacks[message];
    
    // Recherche par mots-clÃ©s si pas de match exact
    if (!fallbackMessage) {
      const messageLower = message.toLowerCase();
      
      for (const [key, value] of Object.entries(personaFallbacks)) {
        if (messageLower.includes(key.toLowerCase().split(' ')[0])) {
          fallbackMessage = value;
          break;
        }
      }
    }
    
    // Fallback gÃ©nÃ©rique adaptÃ© au persona
    if (!fallbackMessage) {
      const genericFallbacks = {
        emma: "Je comprends ! Dis-moi en plus sur ce que tu ressens ? ðŸ’œ",
        laure: "Je vois. Pouvez-vous prÃ©ciser votre ressenti ?",
        clara: "Ah ! Quelle belle opportunitÃ© d'explorer ensemble ! âœ¨",
        sylvie: "Je t'Ã©coute. Prenons le temps d'accueillir ce que tu ressens.",
        christine: "Je comprends. Comment puis-je vous accompagner ?"
      };
      
      fallbackMessage = genericFallbacks[persona] || genericFallbacks.emma;
    }

    return {
      success: true,
      message: fallbackMessage,
      source: 'smart_fallback',
      persona: persona
    };
  }

  // âœ… NOUVEAU : Suggestions intelligentes
  async getSmartSuggestions() {
    try {
      const userStore = useUserStore.getState();
      const currentPhase = getCurrentPhase(
        userStore.cycle.lastPeriodDate,
        userStore.cycle.length,
        userStore.cycle.periodDuration
      );
      
      const chatStore = useChatStore.getState();
      const suggestions = chatStore.getContextualSuggestions();
      
      return suggestions.length > 0 ? suggestions : this.getDefaultSuggestions(currentPhase);
    } catch (error) {
      console.warn('ðŸš¨ Erreur smart suggestions:', error);
      return ["Comment je me sens ?", "Conseils du jour", "Rituels bien-Ãªtre"];
    }
  }

  getDefaultSuggestions(phase) {
    const phaseSuggestions = {
      menstrual: [
        "Comment soulager mes douleurs ?",
        "Rituels cocooning rÃ¨gles",
        "Nutrition pendant les rÃ¨gles"
      ],
      follicular: [
        "Optimiser mon Ã©nergie montante",
        "Nouveaux projets Ã  commencer",
        "Sport adaptÃ© Ã  cette phase"
      ],
      ovulatory: [
        "Profiter de mon pic d'Ã©nergie",
        "Communication et relations",
        "CrÃ©ativitÃ© et socialisation"
      ],
      luteal: [
        "GÃ©rer les changements d'humeur",
        "PrÃ©parer les prochaines rÃ¨gles",
        "Ralentir et m'Ã©couter"
      ]
    };

    return phaseSuggestions[phase] || phaseSuggestions.menstrual;
  }

  // âœ… MÃ‰THODES UTILITAIRES
  async clearContext() {
    this.conversationContext = {
      messageCount: 0,
      topics: [],
      lastPhase: null,
      userPatterns: {}
    };
  }

  getStats() {
    return {
      deviceId: this.deviceId,
      isInitialized: this.isInitialized,
      conversationContext: this.conversationContext
    };
  }
}

export default new ChatService();